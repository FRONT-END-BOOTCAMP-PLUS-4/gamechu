# 워크 플로우 이름 : 우분투 서버에서 빌드와 배포를 위한 워크 플로우
name: "Build and Deploy to Ubuntu Server Run"

# dev 브랜치에 push가 발생하면 jobs가 실행되도록 이벤트 설정
on:
    push:
        branches:
            - dev # dev 브랜치에 push가 발생하면

# 위에 설정된 push 이벤트를 실행할 job들의 순서를 정한다.
jobs:
    # 첫번째 단계 : 빌드
    build:
        runs-on: ubuntu-latest

        env:
            DATABASE_URL: ${{ secrets.DATABASE_URL }}
            NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
            NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
            SOCKET_SERVER_URL: ${{ secrets.SOCKET_SERVER_URL }}

        steps:
            - name: Build Next.js Project
              run: |
                  set -e
                  cd ~/www/gamechu || { echo "Failed to change working directory"; exit 1; }
                  git pull origin dev || { echo "Failed to git pull"; exit 1; }
                  npx prisma generate || { echo "Failed to generate via prisma client"; exit 1; }
                  npm ci || { echo "Failed to install dependencies"; exit 1; }
                  npm run build || { echo "Failed to build"; exit 1; }

    # 두번째 단계: 테스트
    test:
        runs-on: ubuntu-latest

        steps:
            - name: Test Next.js Project
              run: echo "Test Next.js Project"

    # 세번째 단계: 배포
    deploy:
        needs: [build, test]

        runs-on: [self-hosted, gamechu-server]

        env:
            DATABASE_URL: ${{ secrets.DATABASE_URL }}
            NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
            NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
            SOCKET_SERVER_URL: ${{ secrets.SOCKET_SERVER_URL }}

        steps:
            - name: Deploy Next.js Project
              run: /home/gamechu/www/gamechu/next-app-deploy.sh
